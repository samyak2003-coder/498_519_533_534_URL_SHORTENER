name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build Docker image
      run: |
        docker-compose -f docker-compose.yml build
        
    - name: Start Minikube
      run: |
        minikube start --driver=docker
        
    - name: Apply Kubernetes Manifests
      run: |
        kubectl apply -f redis-deployment.yaml
        kubectl apply -f configmap.yaml
        kubectl apply -f secrets.yaml
        kubectl apply -f url-shortener-deployment.yaml
        
    - name: Enable Ingress and HPA in Minikube
      run: |
        minikube addons enable ingress
        minikube addons enable hpa
        
    - name: Apply Ingress and HPA configuration
      run: |
        kubectl apply -f ingress.yaml
        kubectl apply -f hpa.yaml
        
    - name: Port-forward
      run: |
        kubectl port-forward svc/url-shortener-service 8081:80 
        
    - name: Test URL shortening service
      run: |
        for i in {1..100}; do
          curl -s -X POST http://localhost:8081/shorten \
          -H "Content-Type: application/json" \
          -d '{"long_url":"https://smashkarts.io"}' &
          sleep 0.01
        done
